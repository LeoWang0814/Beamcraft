# RGB 导光局（Grid Prism Puzzle）— 2D Web 解谜游戏规格 v0.1

> 目标：给 Codex / 工程实现用的 **可直接落地** 规格。  
> 关键词：**网格编辑**、**光线可斜走**、**离散角度（8 向/16 向）**、**统一 Tick 计时（1 格/ Tick）**、**扁平精致 UI + SVG 资产**、**Vite + React + TS + Tailwind**、可部署 **Vercel**。

---

## 1. 游戏一句话（Pitch）

在网格板上摆放镜子、分色棱镜与滤光器，把一束白光拆成 RGB 三束，并把三束光在 **统一时间系统** 下分别导向对应接收器；每一步放置都会实时重算光路，形成“短局、高反馈、可刷分、可分享解法”的益智解谜体验。

---

## 2. 核心玩法循环

1. 关卡给定：固定元件（发射器、接收器、墙/障碍、部分锁定元件）与可用元件清单（数量/类型限制）。
2. 玩家在 **网格格点** 放置/旋转元件（拖放、点选、快捷键旋转）。
3. 引擎按 **Tick** 逐步模拟光线传播（所有光束速度一致：**1 格 / Tick**）。
4. 满足通关条件：  
   - 三个接收器分别收到正确颜色，且达到强度阈值  
   - 可选：纯度（不得混入其他色）与同步（必须在同一时间窗内到达）
5. 评分与分享：最少元件、最少 Tick、最少反射次数、最少漏光等，生成可复制的解法字符串（Seed + Placements）。

---

## 3. 关卡空间与坐标系

### 3.1 网格与单位

- 网格尺寸：推荐 MVP `12×12` 或 `16×16`（关卡 JSON 指定）。
- 每个格子边长定义为 1 单位（`cellSize = 1`），渲染时再映射到像素（如 `cellPx = 48`）。
- 元件放置：每个格子最多 1 个元件（可扩展大件占用多格，但 MVP 不建议）。

### 3.2 光线：连续画线 + Tick 离散推进

你要求“光不必像素化、可以斜着走”，同时又要求“1 格 / Tick”。

实现建议（两阶段）：

#### 基础关卡（8 向）— **格中心推进（推荐 MVP）**
- 光束状态：`(xCell, yCell, dir)`，位置始终落在格子中心。
- 每 Tick：沿方向移动到相邻格中心（8 向：上下左右 + 4 对角），因此 **移动距离恒为 1 格**，且天然稳定。
- 绘制：将中心点序列用直线连接即可，视觉上是连续斜线，不是阶梯。

> 优点：实现简单、稳定、容易保证“逻辑推理”而不是调参。

#### 进阶关卡（16 向）— **连续坐标推进（建议后续）**
- 光束状态：`pos = (x, y)` 使用连续坐标，方向 `dir` 取 16 个离散角（每 22.5°）。
- 每 Tick：`pos += dirVector * 1`（长度恒为 1 格/ Tick）。
- 交互判定：光束线段与元件“交互域（interaction radius）”相交则触发（见 6.3）。

> 进阶关卡引入 16 向的同时，也建议引入“延迟/同步”等更高阶机制，否则 16 向的价值不明显。

---

## 4. 方向离散规则（强制）

### 4.1 8 向（基础）
方向集合 `D8`：
- 0° 右 `(1, 0)`
- 45° 右上 `(1, -1)`
- 90° 上 `(0, -1)`
- 135° 左上 `(-1, -1)`
- 180° 左 `(-1, 0)`
- 225° 左下 `(-1, 1)`
- 270° 下 `(0, 1)`
- 315° 右下 `(1, 1)`

（格中心推进下，每 Tick 走到相邻格中心，方向向量可归一为单位步长“到邻格”。）

### 4.2 16 向（进阶）
方向集合 `D16`：`k * 22.5°`，`k=0..15`。  
建议预计算单位向量表 `dirVec[k] = (cos, sin)` 并保留足够精度。

### 4.3 元件输出方向约束
- **任何元件产生的出射方向必须落在当前模式的方向集合内**。  
- 切换到 16 向时，元件可支持更多“角度档位”，但仍是离散档位，不允许自由角度。

---

## 5. 光束的颜色与强度模型

### 5.1 颜色表示
MVP 使用离散三色与混色集合即可，不需要连续光谱：
- 单色：`R` / `G` / `B`
- 混色：`Y(R+G)` / `C(G+B)` / `M(R+B)` / `W(R+G+B)`
- 颜色可用 bitmask：`R=1, G=2, B=4`，混色即按位或。

### 5.2 强度表示
- 强度为标量 `intensity ∈ [0, 1]` 或用整数更好（避免浮点误差）：
  - 建议：白光初始 `I = 300`（代表 100%×3 色），棱镜拆分后每色 `100`。
- 常用操作：
  - 透过：强度不变（或按元件效率乘系数，如 95%）。
  - 反射：可选衰减（如 98%）。
  - 分光：按比例拆分（50/50 或可调 70/30）。

### 5.3 时间（Tick）
- 所有光束每 Tick 走 1 格距离，形成统一时间基准。
- 接收器可记录首次收到满足阈值的 Tick，用于“同步通关”。

---

## 6. 元件系统（Grid 工具）

> 所有工具都必须有 **SVG 图标**（扁平、统一线宽、统一圆角）。  
> 元件放置在格子上；旋转只允许离散角度（基础 45°，进阶 22.5°）。

### 6.1 MVP 必做元件（建议最小集合）
1) **发射器 Source（固定）**  
- 属性：颜色（默认白光 `W`），出射方向，初始强度。  
- 行为：每次模拟从 Source 生成 1 条或多条光束（取决于颜色 bitmask）。

2) **棱镜 Prism / Splitter（关键元件）**  
- 目标：把白光拆成 RGB 三束；也能处理混色/单色。
- 建议做成“**分色器**”，避免物理折射角复杂度（玩家推理更强）。
- 规则（8 向建议）：
  - 输入 `W`：输出三束
    - `G`：沿元件朝向直行
    - `R`：相对直行 **左偏 45°**
    - `B`：相对直行 **右偏 45°**
  - 输入为混色：仅对包含的色输出对应子束
  - 强度：输入强度按色平均拆分（或按 bitmask 成分拆分）
- 旋转：45° 档位（基础），进阶可为 22.5° 档位。

3) **镜子 Mirror（/ 与 \\）**  
- 反射规则：遵循镜面法线反射（离散方向下可用查表实现）。
- 两种形态：
  - `/`：法线朝 NE/SW
  - `\\`：法线朝 NW/SE
- 旋转：90° 或 45°（根据你的美术表达，建议仍按 45° 旋转，但只产生两种有效姿态）。

4) **滤镜 Filter（R / G / B）**  
- 行为：只允许指定色通过；其他色分量被吸收（强度扣除并可产生粒子）。
- 用途：纯度要求、去杂、错误路径惩罚。

5) **接收器 Receiver（R / G / B）**  
- 条件：
  - 颜色匹配：只计入指定色分量
  - 强度阈值：例如必须累计达到 `100`
  - 纯度（可选）：如果混入其他色，判失败或扣分
  - 同步（可选）：记录达标 Tick，三者差值 ≤ `syncWindow`（如 2 Tick）

### 6.2 进阶元件（第二阶段）
6) **分光镜 Beam Splitter**  
- 输入一束 -> 输出两束同色：直行 + 反射（或左右分叉）。强度按比例拆分。

7) **合成器 Combiner**  
- 两束或多束进入同一格时合并输出（颜色 bitmask OR），强度相加但可设上限。

8) **延迟玻璃 Delay**  
- 通过后增加 `delayTicks`（等效为在元件内部停留 N Tick 再继续），用于同步谜题。

9) **单向镜 One-way Mirror**  
- 规定方向反射，反向透过，形成“光学二极管”。

> 注意：MVP 先把“分色+镜+滤+接收”做扎实，关卡就够好玩。

### 6.3 交互判定（建议）
#### 8 向格中心推进（MVP）
- 光束每 Tick 进入一个格子中心。
- 若该格子存在元件，则触发交互并决定下一 Tick 的方向/分裂/吸收。
- 如果格外（越界）或进入“墙”格：光束终止。

#### 16 向连续推进（进阶）
- 每 Tick 光束移动一段长度为 1 的线段。
- 若线段与某格中心的交互域（半径 `r = 0.35~0.45`）相交，则视为进入该格并触发元件。
- 为避免一次 Tick 穿过多个交互域：若同时命中多个，取距离起点最近者并截断（剩余距离留到下一 Tick 或当 Tick 内继续推进，二选一；建议简化为“单 Tick 最多触发一次元件”）。

---

## 7. 关卡数据格式（JSON 规范建议）

> 关卡必须可序列化，方便分享与回放。

示例结构（伪 JSON）：

```json
{
  "id": "L01",
  "title": "第一次分光",
  "grid": { "w": 12, "h": 12 },
  "mode": "D8",
  "fixed": [
    { "type": "SOURCE", "x": 1, "y": 6, "dir": 0, "color": "W", "intensity": 300 },
    { "type": "PRISM",  "x": 4, "y": 6, "dir": 0, "locked": true },
    { "type": "RECV_R", "x": 10, "y": 2, "threshold": 100 },
    { "type": "RECV_G", "x": 10, "y": 6, "threshold": 100 },
    { "type": "RECV_B", "x": 10, "y": 10, "threshold": 100 }
  ],
  "walls": [
    { "x": 7, "y": 6 }, { "x": 7, "y": 7 }
  ],
  "inventory": [
    { "type": "MIRROR", "count": 6 },
    { "type": "FILTER_R", "count": 1 },
    { "type": "FILTER_G", "count": 1 },
    { "type": "FILTER_B", "count": 1 }
  ],
  "rules": {
    "purity": false,
    "sync": false,
    "maxBounces": 64,
    "maxTicks": 256
  }
}
```

方向 `dir` 的编码建议：
- D8：用 `0..7` 表示（每个索引对应一个 45°）。
- D16：用 `0..15` 表示（每个索引对应一个 22.5°）。

---

## 8. UI / 交互设计（扁平精致，不“AI 感”）

### 8.1 设计语言（Design Tokens）
**目标：统一、克制、细节精致。**

- 字体：建议 `Inter`（英文）+ `Noto Sans SC`（中文），或系统字体栈也可。
- 基础圆角：`12px`（卡片/面板），按钮 `10px`，网格格子 `8px`。
- 阴影：极轻（2 层：`0 1px 2px`, `0 8px 24px` 低透明度）。
- 线宽：SVG 统一 `stroke-width: 1.75` 或 `2`（根据缩放），端点 `round`。
- 间距：遵循 `8px` 基线（8/16/24/32）。

**颜色建议（示例）**（你可替换为自己的品牌色，但要固定成 tokens）：
- `--bg`: #0F1115
- `--panel`: #161A22
- `--panel2`: #1C2230
- `--text`: #E8ECF4
- `--muted`: #A7B0C3
- `--accent`: #7AA2F7
- `--gridLine`: rgba(255,255,255,0.06)
- 光颜色：
  - R: #FF4D6D
  - G: #3DFF8A
  - B: #4D7CFF

> 要避免“AI 感”，关键是：  
> **统一线宽**、**统一圆角**、**一致的间距体系**、**少而准的颜色 token**、**动画克制**。

### 8.2 布局
- 顶部：关卡标题 + 关卡编号 + Undo/Redo + 重置 + 播放/暂停（可选）。
- 左侧（或底部）：元件工具栏（库存数量、选中态、快捷键提示）。
- 主区域：网格画布（Canvas/SVG 混合渲染）。
- 右侧：目标面板（R/G/B 接收器状态、强度条、同步状态、评分预览）。

### 8.3 编辑交互
- 拖放：从工具栏拖到格子放置。
- 点选：点击格子选中元件，显示旋转把手与删除按钮。
- 旋转：
  - `R`：顺时针 +45°（基础）/ +22.5°（进阶）
  - `Shift+R`：反向旋转
- 删除：`Backspace/Delete`
- Undo/Redo：`Ctrl+Z / Ctrl+Y`
- 运行模式：
  - 默认实时预览（每次编辑立即重算光路）
  - 可切换“播放模式”显示 Tick 动画（便于时间谜题）

---

## 9. 渲染与动效（建议实现策略）

### 9.1 渲染分层
1) **底层网格**：Canvas 或 SVG，画格线、坐标边框、墙体。
2) **元件层**：SVG 图标渲染（每格一个 `<svg>`，或把所有元件合并成一个 SVG overlay）。
3) **光路层**：Canvas（性能好）  
   - 预览模式：直接画整条 polyline
   - 播放模式：按 Tick 逐段绘制（1 格/ Tick 的节奏能体现“同步谜题”）

### 9.2 光线视觉规范
- 线条：`2px~3px`，带轻微外发光（用 Canvas shadowBlur 或重复描边）。
- 颜色混合：混色光线可用“叠加”表现：
  - 简单版：用混色对应的单色（Y/C/M/W）画
  - 更高级：用多层线条叠加（R/G/B 分量各画一条半透明线）

### 9.3 动效
- 放置元件：轻微缩放 + 阴影过渡（100–160ms）。
- 接收器达标：进度条“啪”地填满 + 外圈呼吸一次。
- 错误反馈：接收器轻微抖动（8–12px）+ 红色提示条（不刺眼）。

---

## 10. 模拟引擎（MVP 逻辑流程）

### 10.1 单次重算（实时预览）
1. 清空所有接收器累计值。
2. 从所有 Source 发射初始光束（可能多束）。
3. 对每束光执行最多 `maxTicks`，或直到终止：
   - 读取当前位置所在格
   - 若越界/墙：终止
   - 若遇元件：根据规则更新方向/颜色/强度，必要时分裂为多束
   - 记录路径点（用于绘制）
   - 前进 1 Tick（1 格/ Tick）
4. 统计接收器达标状态与评分。

### 10.2 防止死循环
- 每束光维护 `(cell, dir, colorMask)` 的访问计数，超过阈值终止。
- 或全局 `maxBounces`、`maxTicks` 限制。

### 10.3 评分（建议）
- `score = base - placedCount*10 - totalTicks*1 - bounceCount*2 - leakPenalty`
- 同时记录：
  - `placedCount`
  - `solveTicks`（最晚达标 Tick）
  - `bounceCount`
  - `leakCount`（出界/错误接收）

---

## 11. SVG 资产规范（必须遵守）

### 11.1 统一规格
- 每个元件图标：`viewBox="0 0 64 64"`（统一坐标系）
- 线宽：`stroke-width="2"`，`stroke-linecap="round"`, `stroke-linejoin="round"`
- 圆角：所有矩形使用 `rx="10"` 或更小（根据造型）
- 不使用复杂渐变（扁平风格），最多使用 1 层轻微透明高光。

### 11.2 元件视觉建议
- Source：小型发光圆点 + 方向箭头，白光用三色小点表示“W=RGB”。
- Prism：等边三角形或截角三角，内部用三条细线提示分色方向。
- Mirror：细长玻璃片（半透明填充）+ 反射箭头暗示。
- Filter：带颜色条纹的薄片（R/G/B）。
- Receiver：圆形或方形端口 + 颜色环形进度条。

### 11.3 状态层
- `selected`：外框描边 `--accent`，内阴影更亮。
- `locked`：右上角小锁图标（同样 SVG 线宽）。
- `invalid`：不允许放置时用红色虚线框（透明度 0.6）。

---

## 12. Demo（MVP）验收标准（建议）

1) 能加载 3 个关卡（至少 1 个教程关，1 个中等关，1 个需要滤镜）。
2) 网格编辑：放置、旋转、删除、撤销/重做可用。
3) 光路实时预览正确：棱镜分 RGB、镜面反射、滤镜吸收正确。
4) 接收器 UI：能显示强度进度条与达标状态。
5) 评分面板：至少显示“放置数 / Tick / 反射次数”。
6) 导出解法字符串：`levelId + placements` 可复制，粘贴后可复现。

---

## 13. 技术栈与工程建议（Vite / Vercel 友好）

- `Vite + React + TypeScript`
- `TailwindCSS`（或 CSS Modules + tokens，二选一；若想快速统一视觉，Tailwind 更快）
- 渲染：元件 SVG + 光路 Canvas（推荐）
- 状态管理：`zustand` 或 `useReducer`（MVP 用 `useReducer` 也够）
- 关卡数据：`/src/levels/*.json`
- 部署：Vercel 静态站点（`npm run build` -> `dist/`）

建议目录（供 Codex 生成项目时参考）：

```
src/
  app/
    App.tsx
    routes/
  engine/
    directions.ts
    sim.ts
    components.ts
    level.ts
  ui/
    tokens.css
    Toolbar.tsx
    Inspector.tsx
    Hud.tsx
  render/
    GridCanvas.tsx
    RaysCanvas.tsx
    SvgPiece.tsx
  assets/
    pieces/
      Prism.svg
      Mirror.svg
      FilterR.svg
      ...
  levels/
    L01.json
    L02.json
    L03.json
```

---

## 14. 后续可爆款的扩展（非 MVP 但建议预留）
- 每关可生成短回放 GIF（或导出 JSON 回放）。
- 每日挑战（随机种子关卡）。
- 社区分享（seed + 解法字符串）。
- 关卡编辑器（同一套网格编辑 UI）。

---

### 结语
这个规格刻意选择“分色器棱镜”而不是物理精准折射，目的是让**推理可控**、关卡可设计、玩家体验稳定。  
基础阶段用 8 向格中心推进保证稳定；进阶阶段再切 16 向连续推进并加入时间机制（延迟/同步）才能体现差异。
